# 物料辅助属性与查询指南

## 概述
辅助属性在金蝶云星空通过“弹性域/辅助资料”实现。辅助属性内码（FAUXPROPID / FID）记录组合值，需要先从弹性表查出组合字段值，再根据字段值查辅助资料明细。

## 相关表（简要）
- T_BD_MATERIALAUXPTY：物料与辅助属性关联（FAUXPROPERTYID）。
- T_BD_FLEXAUXPROPERTY：辅助属性表头（FVALUESOURCE、FFLEXNUMBER）。
- T_BD_FLEXSITEMDETAILV：弹性表组合值（FID 对应辅助属性内码）。
- T_BAS_ASSISTANTDATA / _L：辅助资料头（FID、FNUMBER、中文名）。
- T_BAS_ASSISTANTDATAENTRY / _L：辅助资料条目（FENTRYID、FNUMBER、FDESCRIPTION）。

## 常用查询示例
查询即时库存中某辅助属性：
```sql
SELECT * FROM T_STK_INVENTORY WHERE FAUXPROPID = 100007;
```

查看弹性表组合值：
```sql
SELECT * FROM T_BD_FLEXSITEMDETAILV WHERE FID = 100007;
```

查看辅助属性表头：
```sql
SELECT FFLEXNUMBER, * FROM T_BD_FLEXAUXPROPERTY;
```

查看辅助资料具体值（示例）：
```sql
SELECT 
    A.FID,
    A.FNUMBER AS DATA_FNUMBER,
    B.FNAME,
    C.FNUMBER AS ENTRY_FNUMBER,
    C.FENTRYID,
    D.FDESCRIPTION
FROM T_BAS_ASSISTANTDATA A
INNER JOIN T_BAS_ASSISTANTDATA_L B ON A.FID = B.FID AND B.FLOCALEID = 2052
INNER JOIN T_BAS_ASSISTANTDATAENTRY C ON A.FID = C.FID
INNER JOIN T_BAS_ASSISTANTDATAENTRY_L D ON C.FENTRYID = D.FENTRYID AND D.FLOCALEID = 2052
WHERE A.FID IN ('5a797a7d21619f','774920fec7964bfba702b45eeb07af61');
```

## 查询辅助属性组合并还原具体值（SQL Server 示例）
说明：遍历弹性表除 FID、FOPCODE 外的字段，按 FFLEXNUMBER 找到数据来源，再查辅助资料拼接展示。

```sql
DECLARE 
    @MAX_WHILE INT,
    @WHILE_NUM INT,
    @FLEXNUMBER NVARCHAR(128),
    @LS NVARCHAR(100),
    @FENTRYID NVARCHAR(100),
    @FAUXPROPID NVARCHAR(100),
    @VALUESOURCE NVARCHAR(100),
    @RE NVARCHAR(MAX),
    @SQL1 NVARCHAR(MAX),
    @RESULT NVARCHAR(MAX);

SET @FAUXPROPID = '100007'; -- 指定辅助属性内码（FID）
-- 计算弹性表有效字段数（排除 FID、FOPCODE）
SELECT @MAX_WHILE = MAX(SEQ)
FROM (
    SELECT C.NAME, ROW_NUMBER() OVER (ORDER BY C.NAME) SEQ
    FROM SYSCOLUMNS C
    JOIN SYSOBJECTS T ON C.ID = T.ID
    WHERE T.TYPE='U' AND T.NAME='T_BD_FLEXSITEMDETAILV'
      AND C.NAME NOT IN ('FID','FOPCODE')
) T2;

SET @WHILE_NUM = 1;
SET @RESULT = '';

WHILE @WHILE_NUM <= ISNULL(@MAX_WHILE,0)
BEGIN
    SELECT @FLEXNUMBER = NAME
    FROM (
        SELECT C.NAME, ROW_NUMBER() OVER (ORDER BY C.NAME) SEQ
        FROM SYSCOLUMNS C
        JOIN SYSOBJECTS T ON C.ID = T.ID
        WHERE T.TYPE='U' AND T.NAME='T_BD_FLEXSITEMDETAILV'
          AND C.NAME NOT IN ('FID','FOPCODE')
    ) T2
    WHERE SEQ = @WHILE_NUM;

    SET @WHILE_NUM = @WHILE_NUM + 1;
    SET @LS = NULL;

    SET @SQL1 = N'SELECT @LS_OUT = ' + QUOTENAME(@FLEXNUMBER) + N' FROM T_BD_FLEXSITEMDETAILV WHERE FID = ' + @FAUXPROPID;
    EXEC sp_executesql @SQL1, N'@LS_OUT NVARCHAR(100) OUTPUT', @LS OUTPUT;
    SET @FENTRYID = @LS;

    SELECT @VALUESOURCE = FVALUESOURCE FROM T_BD_FLEXAUXPROPERTY WHERE FFLEXNUMBER = @FLEXNUMBER;

    SELECT @RE = (
        SELECT TOP 1
            A.FNUMBER + B.FNAME + C.FNUMBER + '(' + ISNULL(D.FDESCRIPTION,'') + ')'
        FROM T_BAS_ASSISTANTDATA A
        INNER JOIN T_BAS_ASSISTANTDATA_L B ON A.FID = B.FID AND B.FLOCALEID = 2052
        INNER JOIN T_BAS_ASSISTANTDATAENTRY C ON A.FID = C.FID
        INNER JOIN T_BAS_ASSISTANTDATAENTRY_L D ON C.FENTRYID = D.FENTRYID AND D.FLOCALEID = 2052
        WHERE A.FID = @VALUESOURCE AND C.FENTRYID = @FENTRYID
    );

    SET @RESULT = @RESULT + ISNULL(@RE,'');
END

PRINT @RESULT;
```

备注：根据实际表结构和数据类型（FID、FID 值是否带引号）调整脚本。以上脚本用于参考和二次优化。

** 可以通过标准 Web API 查询弹性表组合值（FormId：BD_FLEXSITEMDETAILV）